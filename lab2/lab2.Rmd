# Лабораторная работа 2
## Задачи для лабораторной: 
* манипулирование объектами данных;
* работа с циклами;
* переписывание существующего кода;
* моделирование при помощи генератора случайных величин.

## Требования к оформлению
* Оформить решение в R Markdown. 
* Сохранить файл в свой репозиторий.
* Выгрузить R Markdown в HTML, назвать своим именем и отправить по почте (если хочется сдать раньше или нужна помощь).

## Исходные данные
Установленная среда R включает в себя набор заранее сконфигурированных массивов данных.
В данной лабораторной требуется использовать одну из них  — датафрейм из 93 машин-новинок 1993 года.
Для того, чтобы загрузить данный датафрейм, необходимо выполнить следующие команды:

```{r, echo=FALSE}
library(MASS)
library(tidyverse)
data(Cars93)
```
Для того, чтобы ознакомиться со структурой и составом данных, можно выполнить команду ``View(Cars93)`` 
или нажать на соответствующую кнопку в RStudio.

### Задание 1

1. Выполните команду ``summary()`` на полном наборе данных. Можно ли по результату выполнения сказать сколько строк в датафрейме? Если да, напишите сколько. Если нет, то приведите другой способ.

```{r}
summary(Cars93)
# Данный способ не дал сведений о количестве строк => используем следующий вариант
length(Cars93[[1]])
```

2. Найдите среднюю цену машин с задним приводом.
3. Найдите минимальное число лошадиных сил автомобиля для 7 пассажиров. Для 6 пассажиров.
4. Найдите машины с максимальным, минимальным и средним(медианой) расстоянием, которая машина может проехать по трассе.
Вам понадобятся 2 колонки, чтобы рассчитать расстояние. Какие?

```{r}
Cars93 %>%
  filter(DriveTrain == 'Rear') %>% 
  summarise(mean(Price)) %>% 
  as.double() -> mean.price
Cars93 %>%
  filter(Passengers == 6) %>% 
  summarise(min(Horsepower)) %>% 
  as.double() -> min.horsepower.6
Cars93 %>%
  filter(Passengers == 7) %>% 
  summarise(min(Horsepower)) %>% 
  as.double() -> min.horsepower.7
Cars93 %>%
  mutate(Highway.dist = MPG.highway * Fuel.tank.capacity) %>% 
  filter(Highway.dist %in% c(min(Highway.dist), median(Highway.dist), max(Highway.dist))) %>%
  select(Make, Highway.dist)
```

## Задание 2
В самом начале занятий приводился пример с фабрикой и производством автомобилей.
Ниже приведён пример кода, который старается оптимизировать выпуск продукции ориентируясь на доступные ресурсы.
```{r}
factory.run <- function (o.cars=1, o.trucks=1) {
  factory <- matrix(c(40,1,60,3),nrow=2, dimnames=list(c("трудодни","сталь"),c("автомобили","грузовики")))
  warehouse <- c(1600,70) #Доступно материалов на складе
  names(warehouse) <- rownames(factory)
  reserve <- c(8,1)
  names(reserve) <- rownames(factory)
  output <- c(o.cars, o.trucks)
  names(output) <- colnames(factory)
  
  steps <- 0 # Счётчик числа шагов цикла
  repeat {
    steps <- steps + 1
    needed <- factory %*% output # Подсчитаем ресурсы, которые нам нужны для производства требуемого кол-ва машин
    message(steps)
    print(needed)
    # Если ресурсов достаточно и остаток меньше или равен резерву, то мы произвели максимум возможного.
    # Нужно прекращать
    if (all(needed <= warehouse) && all((warehouse - needed) <= reserve)) {
      break()
    }
    # Если заявка слишком большая и ресурсов недостаточно, уменьшим её на 10%
    if (all(needed > warehouse)) {
      output <- output * 0.9
      next()
    }
    # Если всё наоброт, то увеличим на 10%
    if (all(needed < warehouse)) {
      output <- output * 1.1
      next()
    }
    # Если мы потребили одного ресурса слишком много, а другого недостаточно,
    # то увеличим план на случайную величину
    output <- output * (1+runif(length(output),min=-0.1,max=0.1))
  }
  
  return(output)
}
factory.run()
```
1. Выполните код и запустите эту функцию ``factory.run()``.
2. С каким входными значениями функция вызвана? Какой получился результат?
3. Повторите вызов 4 раза. Полученные ответы отличаются от полученных ранее? Если да, почему? Если нет, почему?
```
Входные параметры: o.cars = o.trucks = 1
Автомобилей: 10.13902
Грузовиков: 19.88522

Результат работы функции каждый раз разный. Особенно сильно различалось количество шагов, требуемое для завершения - удалось достичь разброса от 150 до 28447. Причина этого - наличие ГСЧ в теле функции.
```

4. В приведённом коде, переменные _steps_ и _output_ находятся внутри алгоритма.
Измените функцию так, чтобы она возвращала число шагов и произведённое количество машин.

```{r}
factory.run.with.steps <- function (o.cars=1, o.trucks=1) {
  factory <- matrix(c(40,1,60,3),nrow=2, dimnames=list(c("трудодни","сталь"),c("автомобили","грузовики")))
  warehouse <- c(1600,70) #Доступно материалов на складе
  names(warehouse) <- rownames(factory)
  reserve <- c(8,1)
  names(reserve) <- rownames(factory)
  output <- c(o.cars, o.trucks)
  names(output) <- colnames(factory)
  
  steps <- 0 # Счётчик числа шагов цикла
  repeat {
    steps <- steps + 1
    needed <- factory %*% output # Подсчитаем ресурсы, которые нам нужны для производства требуемого кол-ва машин
    #message(steps)
    #print(needed)
    # Если ресурсов достаточно и остаток меньше или равен резерву, то мы произвели максимум возможного.
    # Нужно прекращать
    if (all(needed <= warehouse) && all((warehouse - needed) <= reserve)) {
      break()
    }
    # Если заявка слишком большая и ресурсов недостаточно, уменьшим её на 10%
    if (all(needed > warehouse)) {
      output <- output * 0.9
      next()
    }
    # Если всё наоброт, то увеличим на 10%
    if (all(needed < warehouse)) {
      output <- output * 1.1
      next()
    }
    # Если мы потребили одного ресурса слишком много, а другого недостаточно,
    # то увеличим план на случайную величину
    output <- output * (1+runif(length(output),min=-0.1,max=0.1))
  }
  
  output <- c(steps, output, needed)
  names(output) <- c("Число шагов", colnames(factory), rownames(needed))
  return(output)
}

factory.run.with.steps(30, 20)
```

5. Установите план равный тридцати автомобилям и 20 грузовикам и выполните функцию.
   1. Какой получили результат?
   2. Каким получился итоговый запрос ресурсов (переменная _needed_)
   3. Как много итераций пришлось пройти, чтобы получить ответ (переменная _steps_)? 
   4. Для подсчёта можно пользоваться функциями печати (``print``, ``message``) или вернуть результат из функции.
   
```
Используем доработанную функцию из п. 4.
В целом функция стала тратить меньше шагов для завершения, однако плана так и не смогла достичь - не хватает запаса ресурсов.
```